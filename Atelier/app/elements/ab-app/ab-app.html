<link rel="import" href="/bower_components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/iron-icons/image-icons.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">

<!-- /build -->


<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">


<link rel="import" href="/styles/app-theme.html">
<link rel="import" href="/styles/shared-styles.html">
<link rel="import" href="ab-app-styles.html">
<!-- build:remove -->

<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/elements/common/pa-menu.html">
<link rel="import" href="/elements/common/pa-pages.html">
<link rel="import" href="/elements/common/pa-footer.html">
<link rel="import" href="/elements/pa-menu-item/pa-menu-item.html">

<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<!-- /build -->

<!-- the following script can help you formatting the dates -->
<script type="text/javascript" src="../../js/utils.js"></script>

<dom-module id="ab-app">
  <template>
    <style is="custom-style" include="shared-styles ab-app-styles"></style>
    <style is="custom-style">
      paper-toolbar {
        --paper-toolbar-background: #E01010;
        --paper-toolbar-color: white;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
       route="{{route}}"
       pattern="/:page"
       data="{{routeData}}"
       tail="{{subroute}}">
    </app-route>

    <!-- build:remove -->

    <app-route
       route="{{subroute}}"
       pattern="/:playlistid"
       data="{{subrouteData}}">
    </app-route>

    <paper-scroll-header-panel fixed>

      <paper-toolbar class="top-toolbar">
        <h1><a data-route="dashboard" href="#" on-click="onDataRouteClick">UALAC</a></h1>
        <paper-icon-button icon="menu" class="toggle-drawer" on-click="toggleDrawer"></paper-icon-button>
        <span class="flex"></span>
        <!-- <paper-icon-button icon="refresh" class="refresh-icon"></paper-icon-button> -->
        <!-- <pa-search></pa-search>  -->
      </paper-toolbar>

      <paper-drawer-panel id="paperDrawerPanel">

        <paper-scroll-header-panel drawer>
          <pa-menu route="{{route}}" user="{{user}}"></pa-menu>
        </paper-scroll-header-panel>

        <paper-scroll-header-panel main>
          <pa-pages routers="{{page}}" ></pa-pages>
          <pa-footer></pa-footer>
        </paper-scroll-header-panel>

      </paper-drawer-panel>

    </paper-scroll-header-panel>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'ab-app',

        properties: {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged'
          },


          // <!-- build:remove -->
          params: {
            type: Object,
            notify: true
          },
          userid:{
            type: String,
            value: '583414e7479aab0ac483d382'
          },
          tracks:{
            type:Array
          },
          albums:{
            type:Array
          },
          artists:{
            type:Array
          },
          playlists:{
            type: Array
          },
          selectedPlaylist:{
            type:Object
          }

          // <!-- /build -->
        },

        observers: [
          '_routePageChanged(routeData.page)',
          // <!-- build:remove -->
          '_routesubPageChanged(subrouteData.playlistid)'

          // <!-- /build -->

        ],

        // <!-- build:remove -->
        created: function(){
          this._hasReceivedAJAXPlaylistsResponse = false;
        },


        // <!-- /build -->

        _routePageChanged: function(page) {
          // console.log(page)
          // <!-- build:remove -->

          this.page = page || 'dashboard';
          console.log("route is " + this.page);

          // <!-- /build -->

        },

        // <!-- build:remove -->

        _pageChanged: function(page) {
          const acceptedPages = ['dashboard', 'article', 'view404']
          if(acceptedPages.indexOf(page) < 0){
            this.page = 'view404';
          }
        },

        _routesubPageChanged: function(playlistid){
          if(this.page !== 'playlists') return;

          this._validatePlaylistId(playlistid, (err, found) => {
            if(!found){
              this.$.toast.text = 'Can\'t find playlist with id: ' + playlistid  + '. Redirected you to Home Page';
              this.$.toast.show();
              this.page = '/'
            }
          })

        },

        _onPlaylistAjax: function(event){
          this._hasReceivedAJAXPlaylistsResponse = true;
        },

        // page middleware for playlit
        _validatePlaylistId: function(playlistid, cb, timesTried){
          timesTried = timesTried || 0;
          let found = false;

          // try 10 times and then surrender
          if(timesTried >9){
            return next(null, found);
          }

          // make sure we have playlists
          if(!this._hasReceivedAJAXPlaylistsResponse){
            return this.async(function(){
              this._validatePlaylistId(playlistid, cb, ++timesTried)
            }, 500)
          }

          for(let i = 0, l= this.playlists.length; i<l; i++){
            if(this.playlists[i]._id == playlistid){
              this.selectedPlaylist = this.playlists[i];
              found = true;
              break;
            }
          }
          cb(null, found);
        },

        _hideToast(){
          this.$.toast.hide();
        },

        _calcPlaylistHref(pid){
          return `/playlists/${pid}`;
        }
        // <!-- /build -->
      });

    })();
  </script>

</dom-module>
