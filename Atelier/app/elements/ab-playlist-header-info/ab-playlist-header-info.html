<link rel="import" href="/bower_components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/styles/shared-styles.html">
<!-- /build -->

<dom-module id="ab-playlist-header-info">
  <template>

  <!-- build:remove -->
  <style include="shared-styles"></style>
  <style>
    :host{
      @apply(--layout-horizontal);
    }

    #canvas-container{
      padding: 10px;
      width: 230px;
    }

    #playlist-info{
      padding: 10px;
      color: gray;
      flex: 2;
    }

    #playlist-info-name{
      font-weight: bold;
      font-size: 2em;
      color: #333;
      padding-bottom: 2px;
      border-bottom: 1px solid #713F40;
    }
  </style>

  <!-- Exercise 1.d -->
  <div id="canvas-container">
    <canvas width="200" height="200" style="border: 1px dashed gray; background-color:transparent;" id="playlistArtworkCanvas"></canvas>   
  </div>
  <div id="playlist-info">
      <div id="playlist-info-name">[[playlist.name]]</div>
      <div id="playlist-info-track-num">[[playlist.tracks.length]] tracks</div>
  </div> 

  <!-- /build -->
  </template>
  
  <script>

    (function () {
      'use strict';

      Polymer({
        is: 'ab-playlist-header-info',
        //<!-- build:remove -->

        properties: {
          playlist: {
            type:Object,
            notify: true,
            observer: "_generatePlaylistArtwork"
          }
        },

        _emptyPlaylistArtwork: function() {
          const canvas = this.$.playlistArtworkCanvas;
          const ctx = canvas.getContext('2d');

          ctx.fillStyle="#F0F0F0";
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.stroke();
        },

        _generatePlaylistArtwork: function () {
          this._emptyPlaylistArtwork();

          const canvas = this.$.playlistArtworkCanvas;
          const ctx = canvas.getContext('2d')

          const w2 = canvas.width/2;
          const h2 = canvas.height/2;

          const images = this.get4PlaylistImages();

          for(let i in images) {

            const tempImage = new Image()
            tempImage.pos = i
            tempImage.onload = function(evt) {
              const pos = this.pos
              const x = (pos/2 >=1) ? w2: 0;
              const y = (pos%2 ==1) ? h2: 0;
              ctx.drawImage(evt.target,x,y , w2, h2);
            }
            //load image with url that starts from the root
            // to make routing easier
            tempImage.src = `/${images[i]}`;
          };
        },

        get4PlaylistImages: function(){
          const tracks = this.playlist.tracks;
          if(!tracks.length) return;

          const seen = {};
          const artworks = [];
          for(let i in tracks){
            if(artworks.length == 4) return artworks;

            const album = tracks[i].album;
            if(!album) continue;

            if(seen[album._id]) continue;

            seen[album._id] = true;
            artworks.push(album.artwork);
          }
          return artworks;
        }
        //<!-- /build -->

      });

    })();
  </script>

</dom-module>


