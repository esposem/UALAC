<link rel="import" href="/bower_components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-menu-behavior/iron-menu-behavior.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html" >
<!-- /build -->

<dom-module id="ab-player">
  <template>

    <!-- build:remove -->
    <style>
      :host{
        background: rgb(66, 66, 66);
        padding: 5px 10px;
        @apply(--layout-horizontal);
      };

      .btn-icon{
        width:22px;
        height:22px;
        color: #f7f7f7;
        cursor: pointer;
        opacity: 0.65;
        @apply(--ab-player-icon-mixin);
      }

      .btn-icon:hover{
        opacity: 1;
      }

      #pl-info-wrapper{
        height:50px;
      }

      #pl-wrapper{
        width:100%;
        display: -webkit-flex;
        display: flex;
        align-items: flex-end;
      }

      #pl-controls{
        flex: 0 0 auto;
        padding: 2px 10px;
      }

      #pl-progress{
        flex: 1;
        padding: 7px 5px;
        display:flex;
        flex-direction: column;
      }

      #pl-progress-container{
        flex: 1;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .time{
        color: #f7f7f7;
        font-size:0.85em;
        flex : 0 0 auto;
      }

      #play-pause{
        width: 34px;
        height: 34px;
      }

      #pl-timeline-wrapper, #pl-volume-wrapper{
        flex: 1;
        padding: 0 10px;
        vertical-align: middle;
      }

      #pl-timeline-rail, #pl-timeline-bar,
      #pl-volume-rail, #pl-volume-bar{
        border-radius:3px;
      }

      #pl-timeline-rail, #pl-volume-rail{
        padding: 4px 0;
        position:relative;
        background-color: #ccc;
        width:100%;
        cursor:pointer;
        background-clip: content-box;
        height: 3px;
      }

      #pl-timeline-bar, #pl-volume-bar{
        position:absolute;
        height: 3px;
        top:4px;left:0;
        background: var(--ab-secondary-background-color);
      }

      #pl-timeline-bar{
         @apply(--ab-player-time-progress-mixin);
      }

      #pl-volume{
        flex: 0 0 120px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding: 7px 5px;
      }

      #pl-artwork{
        float:left;
        height:50px;
        width:50px;
      }

      #pl-track-info{
        /*margin-left:140px;*/
        padding-left: 5px;
        display: -webkit-flex;
        display: flex;
        color: #FAFAFA;
      }

      #media-object{
        height: 100%;
        position:relative;
      }

      .pl-track-title {
        padding: 0 10px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        border-bottom: 0;
        line-height: 19px;
        max-height: 38px;
        color:#F7F7F7;
      }

      .pl-track-artist{
        padding: 0 10px;
        flex: 1;
        color: #999;
        text-align: right;
      }

      .pl-track-subtitle{
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #mo-image {
        background-position: center;
        background-size: cover;
        padding-bottom: 100%;
        position: relative;
      }

      a{
        text-decoration: none;
      }

      a:hover, a:active{
        text-decoration: underline;
      }

    </style>

    <audio id="audio" src$="[[track.file]]" on-timeupdate="_onTimeupdate" on-loadedmetadata="_onLoadedmetadata"></audio>

    <div id="pl-info-wrapper">
     <div id="pl-artwork">
       <div id="media-object">
         <div id="mo-image" style="background-image: url(../../images/albums/al1.jpg);"></div>
       </div>
     </div>
    </div>
    <div id="pl-wrapper">
    <!--  <audio id="leplayer" onloadedmetadata=>
       <source src="https://archive.org/download/testmp3testfile/mpthreetest.mp3" type="audio/mpeg">
       Your browser does not support the audio tag.
     </audio> -->
      <div id="pl-controls">
        <iron-icon class="btn-icon" id="previous" icon="av:skip-previous"></iron-icon>
        <iron-icon class="btn-icon" id="play-pause" icon="{{_calcPlayIcon(isPlaying)}}" on-tap="_togglePlay"></iron-icon>
        <iron-icon class="btn-icon" id="next" icon="av:skip-next"></paper-icon-button>
      </div>
      <div id="pl-progress">
        <div id="pl-track-info">
          <a title="Thin Lizzy" class="pl-track-artist" href="artists/Iron Maiden">[[track.artist.name]]</a>
          -
          <a class="pl-track-title" href="albums/Seventh Son of a Seventh Son">[[track.name]]</a>
        </div>

        <div id="pl-progress-container">
          <div class="time time-elapsed" id="time-elapsed">0:00</div>
          <div id="pl-timeline-wrapper">
            <div id="pl-timeline-rail" on-click="_timelineRailClicked">
              <div id="pl-timeline-bar"></div>
            </div>
          </div>
          <div class="time time-total" id="time-total">2:19</div>
        </div>
      </div>
      <div id="pl-volume">
        <iron-icon class="btn-icon" icon="av:volume-down" id="volume-down"></iron-icon>
        <div id="pl-volume-wrapper">
          <div id="pl-volume-rail">
            <div id="pl-volume-bar"></div>
          </div>
        </div>
        <iron-icon class="btn-icon" icon="av:volume-up" id="volume-up"></iron-icon>
      </div>
    </div>
  <!-- /build -->
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'ab-player',

        //<!-- build:remove -->
        properties: {

          isPlaying:{
            type: Boolean,
            value: false,
            notify: true
          },

          track:{
            type: Object,
            notify: true
          }
        },

        _togglePlay: function(){
          if(this.isPlaying){
            this.$.audio.pause();
          }else{
            this.$.audio.play();
          }
        },

        _calcPlayIcon: function(isPlaying){
          return (isPlaying) ? 'av:pause' : 'av:play-arrow';
        },

        _onLoadedmetadata: function(){
          //set total time
          this.$['time-total'].innerHTML = formatTime(Math.floor(this.$.audio.duration));

          //set volume
          this.$['pl-volume-bar'].style.width = `${(this.$.audio.volume * 100)}%`;
        },

        _onTimeupdate: function(){
          // Calculate the slider value
          const value = (100 / this.$.audio.duration) * this.$.audio.currentTime;

          // Update the seek bar
          this.$['pl-timeline-bar'].style.width = `${value}%`;

          // Update the elapsed time
          this.$['time-elapsed'].innerHTML = formatTime(Math.floor(this.$.audio.currentTime));
        },

        _timelineRailClicked: function(event){
          var frac = (event.offsetX / this.$['pl-timeline-rail'].offsetWidth);
          this.$['pl-timeline-bar'].style.width = `${(frac * 100)}%`;

          // Calculate the new time
          var time = this.$.audio.duration * frac;
          this.$.audio.currentTime = time;
        }
      //<!-- /build -->
      });

    })();
  </script>

</dom-module>