<link rel="import" href="../../pa-typo/widgets/pa-typo-content.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/styles/shared-styles.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="/elements/menu-item/menu-item.html">
<link rel="import" href="/elements/menu-component/menu-component.html">
<link rel="import" href="/elements/article-item/article-item.html">
<link rel="import" href="/elements/switch-view/switch-view.html">
<link rel="import" href="/elements/image-component/image-component.html">
<link rel="import" href="/bower_components/iron-ajax/iron-request.html">
<link rel="import" href="/bower_components/file-upload/file-upload.html">

<dom-module id="pa-text-inputs" is="dom-bind">
  <template>
    <style include="shared-styles"></style>
    <style>
      a {
        text-decoration: none;
        color: #222;
      }

      paper-button {
        display: block;
        margin-bottom: 0px;
        border: 1px red;
      }

      paper-button[toggles] {
        transition: background-color 0.3s;
      }

      paper-button[toggles][active] {
        background-color: lightcoral;
      }

      paper-button[toggles][active].colorful {
        background-color: rgba(66, 133, 244, 0.25);
      }

      paper-button[toggles][active][raised].colorful {
        background-color: rgba(66, 133, 244, 0.75);
      }

      paper-button.blue {
        --paper-button-flat-focus-color: var(--paper-light-blue-50);
        color: var(--paper-light-blue-500);
      }
      paper-button.blue:hover {
        background: var(--paper-light-blue-50);
      }
      paper-button.red {
        --paper-button-flat-focus-color: var(--paper-red-50);
        color: var(--paper-red-500);
      }
      paper-button.red:hover {
        background: var(--paper-red-50);
      }
      paper-button.orange {
        --paper-button-flat-focus-color: var(--paper-orange-50);
        color: var(--paper-orange-500);
      }
      paper-button.orange:hover {
        background: var(--paper-orange-50);
      }

      paper-button.hover:hover {
        background: #eee;
      }

      paper-button.ripple {
        --paper-button-ink-color: var(--paper-pink-a200);
      }

      pa-simple-grid{
        margin-left: -15px;
        margin-right: -15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }

      paper-material{
        min-width: 95%;
        max-width: 95%;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      paper-textarea{
        min-height: 70px;
        max-height: 300px;
        overflow-y: scroll;
        /*margin-top: 50px;*/
      }

      .fit{
        left:5px;
      }

      #title-field-title {
        align-self: center;
        padding-top: 16px;
        padding-bottom:0px;
        padding-right: 15px;"
      }

      #title {
        flex-grow: 0;
        align-self: center;
        padding:0px;
        width:40%;
      }

      #title-id {
        align-self: center;
        padding-top: 16px;
        padding-bottom:0px;
        padding-right: 15px;
        padding-left: 15px;
      }

      #articleid {
        align-self: center;
        padding-top: 16px;
        width:40%;
      }

      .hidden {
        display: none;
      }

    </style>
    <pa-simple-grid sm-cols="1">
      <paper-material class="widget" elevation="1">

        <div class="vertical-section">

          <div style="display: flex; flex-direction: row">

            <div id="title-field-title" class="paper-font-title">
                Name </div>

            <paper-input id="title" required auto-validate error-message="needs some text!" label="Article title"></paper-input>

            <div id="title-id" class="paper-font-title">
                  ID
              </div>

            <div id="articleid" >
              <i style="font-weight: bold;">No id yet</i>
            </div>

          <a href="/article" style= "width:20%; text-align: center; margin-top: 20px;"> <paper-button tabindex="0" id="submitbutton" on-click="deleteverything"  raised noink
                > New Article</paper-button> </a>

          </div>

        </div>
        <paper-toast id="toast">
        </paper-toast>

        <app-location route="{{route}}"></app-location>
            <app-route
               route="{{route}}"
               pattern="/:page"
               data="{{routeData}}"
               tail="{{subroute}}">
            </app-route>
            <app-route
               route="{{subroute}}"
               pattern="/:articleid"
               data="{{subrouteData}}">
            </app-route>

          <br></br>
          <div style="display:flex; flex-direction: column;">
            <div style="display: flex; flex-direction: row;">
              <!-- <paper-button tabindex="0" id="htmlbutton" toggles raised noink on-click="ishtml" style= "width:auto; text-align: center;">Text Only</paper-button> -->
              <!-- <paper-button tabindex="0" class$="{{hiddenClass}}" toggles raised noink on-click="toggleAutoBr" style= "width:auto; text-align: center;">Auto &#60;br&#62;</paper-button> -->
              <paper-button tabindex="0" raised on-click="addImage" style="width:0%; text-align: center;">Image</paper-button>
              <paper-button tabindex="0" raised on-click="addSwitch" style="width: auto; text-align: center;">Switch View</paper-button>
              <paper-button tabindex="0" raised on-click="addMenu" style="width:0%; text-align: center;">Menu</paper-button>
              <paper-button tabindex="0" raised on-click="addMenuItem" style="width:auto; text-align: center;">Menu Item</paper-button>
<div>
  <!-- <iron-request id="ajaxreq"></iron-request> -->
  <!-- <form id="upl-form" method="POST" enctype="multipart/form-data">
    <input type="file" id="inputcoso" on-change="changes"></input>
    <input type="submit" value="Submit">
  </form> -->
  <file-upload target="/preview" method="POST">Choose File</file-upload>
</div>
            </div>
            <!-- <p class$="{{hiddenClass}}">&#60;div&#62;</p> -->
            <paper-textarea id="inputbox" label="Write the article here" on-keypress="checkBr" on-input="clicked" value=" "></paper-textarea>
            <!-- <p class$="{{hiddenClass}}">&#60;/div&#62;</p> -->
            <div style="display:flex; flex-direction: row-reverse;">
              <iron-ajax
              id="ajax"
              url="/dashboard"
              handle-as="json"
              content-type ="application/json"
              on-response="finished">
            </iron-ajax>
            <iron-ajax
            id="ajax2"
            url="/dashboard"
            handle-as="json"
            content-type ="application/json"
            on-response="loaded">
          </iron-ajax>

              <paper-button tabindex="0" id="submitbutton" on-click="ajaxrequest" raised noink style= "width:0%; text-align: center; margin-top: 20px;">create</paper-button>
               <paper-button id="prev"  raised="" disabled="" style= "width:0%; text-align: center; margin-top: 20px;"><a target="_blank" href="/preview/" > preview </a></paper-button>

            </div>
          </div>
        </div>
      </paper-material>
    </pa-simple-grid>

    <br>
    <br>
    <pa-simple-grid sm-cols="1" >
      <paper-material class="widget" elevation="1">
      <h4>
        Result
      </h4>

      <div id= "demo" style="word-wrap: break-word;">
        <div>
          Nothing to show
        </div>
      </div>
    </paper-material>
  </pa-simple-grid>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'pa-text-inputs',
        properties : {

          html_clicked : {
            type : Boolean,
            value : false,
          },

          br_clicked : {
            type : Boolean,
            value : false,
          },

          wrotebefore : {
            type : String,
          },

          hiddenClass: {
            type : String,
            value : ""
          },

          page : {
            type : String,
            reflectToAttribute : true,
            // observer: '_pageChanged',
          },
          subpage: {
            type : String,
            reflectToAttribute : true,
          },
        },



        changes : function(e){

        },

        observers: [
          '_subroutePageChanged(subrouteData.articleid)',
          '_routePageChanged(routeData.page)',
        ],

        _hiddenprev : function(){
          let id = this.$.articleid;
          // console.log(id);
          let prevbutt = this.$.prev;
          this.$.prev.setAttribute("disabled","")
        },

        _shownprev: function(id){
            let prevbutt = this.$.prev;
            this.$.prev.childNodes[0].href = id;
            this.$.prev.removeAttribute("disabled")
          // }
        },

        _routePageChanged: function(page) {
          // console.log(page)
          this.page = page;
        },

        _subroutePageChanged: function(subroute) {
          // console.log(subroute);
          if(this.page === "article" && subroute){
            let ajaxel = this.$.ajax2;
            ajaxel.url = "/dashboard/" + subroute
            ajaxel.method = "GET"
            ajaxel.generateRequest();
            this._shownprev("/preview/" + subroute);
          }
        },

        // ishtml: function() {
        //   this.html_clicked = !(this.html_clicked);
        //   if (!this.html_clicked) {
        //     this.hiddenClass = "";
        //     this.$.demo.childNodes[1].innerHTML = this.$.inputbox.value;
        //   } else {
        //     this.hiddenClass = "hidden";
        //     if(this.$.demo.childNodes[1].innerHTML) {
        //       let text = this.$.demo.childNodes[1].innerHTML.split("<").join("&#60;");
        //       text.split(">").join("&#62;");
        //       this.$.demo.childNodes[1].innerHTML = text;
        //     };
        //   }
        // },
        //
        // toggleAutoBr : function() {
        //   this.br_clicked = !(this.br_clicked);
        //   if (this.br_clicked) {
        //     this.$.inputbox.value += "<p>";
        //   } else {
        //     this.$.inputbox.value += "</p>";
        //   }
        // },
        //
        clicked: function(e) {
          // console.log(e.keyCode);
          let x = this.$.inputbox.value;
          let text = x || "Nothing to show";
          if(this.html_clicked) {
            text = text.split("<").join("&#60;");
            text = text.split(">").join("&#62;");
            text = text.split("\n").join("<br>");
          } else {
            // text = text.split("<br>").join("\n");
          }
          this.$.demo.childNodes[1].innerHTML =  text;
          this.wrotebefore = text;
          // this.$.inputbox.value = "a" + this.$.inputbox.value;
        },

        checkBr: function(e) {
          if (this.br_clicked && !this.html_clicked && e.keyCode == 13) {
            e.preventDefault();
            this.$.inputbox.value += "<br>\n";
          }
        },

        addImage: function() {
          this.$.inputbox.value += "<image-component tags='src=\"image URL\" alt=\"image\"' normal=\"normal description\" simplified=\"simplified description\" emotional=\"emotional description\" text=\"text to speak\"></image-component>";
          this.clicked();
        },

        addSwitch: function() {
          this.$.inputbox.value += '<switch-view title="insert title here"'
      		this.$.inputbox.value +='normal="insert normal text here"'
      		this.$.inputbox.value +='simplified="insert simplified text here"'
      		this.$.inputbox.value +='emotional="insert image path here">'
      		this.$.inputbox.value +='</switch-view>';
          this.clicked();
        },

        addMenu: function() {
          this.$.inputbox.value += '<menu-component id="main-menu">'
        	this.$.inputbox.value += 'insert menu-item here'
        	this.$.inputbox.value += '</menu-component>'
          this.clicked();
        },

        addMenuItem: function() {
          this.$.inputbox.value += '<menu-item value="insert button name here" link="insert link here"></menu-item>'
          this.clicked();
        },

        deleteverything: function(){
          this.$.articleid.childNodes[1].innerHTML = "No id yet"
          this.$.inputbox.value = ""
          this.$.title.value=" "
          this.$.title.value=""
          this.$["title-field-title"].style="";
          this.clicked();
          this._hiddenprev();
          // console.log(this.$.title);
        },

        ajaxrequest : function(){
          let ajaxel = this.$.ajax;
          let txt = this.$.inputbox.value;
          let tle = this.$.title.value;
          // console.log(this.$.articleid.childNodes[1].innerHTML);
          if(tle){
            // console.log("title valid");
            let id = this.$.articleid.childNodes[1].innerHTML;
            if(id !== "No id yet"){
              // console.log("Put Request");
              ajaxel.method="PUT"
              ajaxel.body = JSON.stringify({"_id" : id, "text": txt, "title" : tle});
            }else{
              // console.log("Post Request");
              ajaxel.method="POST"
              ajaxel.body = JSON.stringify({"text": txt, "title" : tle});
            }
            ajaxel.generateRequest();

          }else{
              // console.log("title is not valid! no request made");
              this.$.title.value = " "; // Done to show the error in the paper-input
              this.$.title.value = "";
              this.$["title-field-title"].style="color: red;";
          }

        },

        finished : function(el){
          let id = this.$.articleid.childNodes[1].innerHTML;
          if(id === "No id yet"){
            this.$.articleid.childNodes[1].innerHTML = el.detail.response;
            this.$.toast.text = 'Created a new Article!';
            this.$.toast.show();
            this._shownprev("/preview/" + el.detail.response);
          }else{
            this.$.toast.text = 'Article ' + id + " updated!";
            this.$.toast.show();
          }
        },

        loaded : function(el){
          // console.log(el.detail.response);
          this.$.inputbox.value = el.detail.response.text;
          this.$.inputbox.value += " "
          this.$.title.value = el.detail.response.title;
          this.$.articleid.childNodes[1].innerHTML = el.detail.response._id;
          this.clicked();
        }


      });
    })();
  </script>

</dom-module>
